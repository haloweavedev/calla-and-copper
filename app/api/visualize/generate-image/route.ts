import { google } from '@ai-sdk/google'
import { generateText } from 'ai'
import { NextRequest, NextResponse } from 'next/server'

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const { roomImageUrl, productImageUrl, productCategory, roomDescription, mainFurnitureItem } = body

    // Validate all required fields are present
    if (!roomImageUrl || !productImageUrl || !productCategory || !roomDescription || !mainFurnitureItem) {
      return NextResponse.json(
        { error: 'Missing required fields: roomImageUrl, productImageUrl, productCategory, roomDescription, mainFurnitureItem' },
        { status: 400 }
      )
    }

    console.log('[API] Generating image with Gemini for product category:', productCategory)

    const gemini = google('gemini-2.5-flash-image-preview')

    // Construct detailed prompt for image generation
    const prompt = `You are an expert interior designer and photo editor. Your task is to seamlessly integrate a product into a real room photo to create a photorealistic visualization.

CONTEXT:
- Room Description: ${roomDescription}
- Current Main Furniture: ${mainFurnitureItem}
- Product Category: ${productCategory}

INSTRUCTIONS:
1. Analyze the first image (the room) to understand the lighting, perspective, and spatial layout
2. Analyze the second image (the product) to understand its design, materials, and proportions
3. Seamlessly replace or add the product into the room in a natural, realistic way
4. Ensure the product fits the room's scale, lighting conditions, and perspective
5. Maintain photorealistic quality with proper shadows, reflections, and lighting
6. The final result should look like a professional interior design photo

TECHNICAL REQUIREMENTS:
- Match lighting direction and intensity from the room
- Maintain proper perspective and scale
- Add realistic shadows and reflections
- Ensure color harmony with the existing room palette
- Generate only the final composite image, no text overlays or explanations

Create a single, high-quality, photorealistic image showing the product naturally integrated into the room.`

    const result = await generateText({
      model: gemini,
      messages: [
        {
          role: 'user',
          content: [
            { type: 'text', text: prompt },
            { type: 'image', image: roomImageUrl },
            { type: 'image', image: productImageUrl }
          ]
        }
      ],
      providerOptions: {
        google: {
          responseModalities: ['IMAGE']
        }
      }
    })

    console.log('[API] Gemini generation completed, checking for image files...')

    // Check if result contains image files
    if (!result.files || result.files.length === 0) {
      throw new Error('No image was generated by Gemini')
    }

    // Get the first generated image file
    const imageFile = result.files[0]
    console.log('[API] Image file received, type:', imageFile.mediaType)

    // The file object provides base64 data directly
    const dataUrl = imageFile.base64

    console.log('[API] Constructed Data URL (first 100 chars):', dataUrl.substring(0, 100))
    console.log('[API] Image generation successful, returning data URL')

    return NextResponse.json({ imageUrl: dataUrl }, { status: 200 })

  } catch (error) {
    console.error('[API] Error in generate-image route:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}